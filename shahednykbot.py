import asyncio
import logging
import os
import random
from telethon import TelegramClient, events
from telegram import Bot

# 🔐 Конфігурація
api_id = 26549615
api_hash = 'f43d6245868e5bae41c40872fb873dec'
SESSION_NAME = 'anon'
bot_token = '7395027911:AAGkiRcvxs8hP878uv9nvo5mGwDe39loxFg'
chat_id = -2416827567  # 👈 заміни на ID своєї групи

client = TelegramClient(SESSION_NAME, api_id, api_hash, phone=lambda: os.getenv('TELEGRAM_PHONE'))

bot = Bot(token=bot_token)

# 🔑 Ключові слова
keywords = ['шахед', 'ракета', 'іскандер', 'кінжал', 'бпла', 'дрон', 'ппо', 'летить', 'приліт', 'загроза', 'удар']
banwords = ['донат', 'монобанка', 'підписуйтесь', 'аналітика', 'заява', 'політика', 'партнерство', 'заклик']

# 😂 Жарти
jokes_default = [
    
    '💩 Летить гівно — як завжди по графіку!',
    '🧻 Прилетіла ср...а — тримай туалет!',
    '🪖 Кінжал летить — заховайся в каструлю!',
    '🧠 ППО працює, а ти працюй над собою!',
    '🔥 Ракета на підльоті — не панікуй, гори спокійно!',
    '💩 Щось летить, тримай каску!',
    '🔥 Приліт буде смачний, сховай сраку!',
    '🛸 Погані шахедики на горизонті!',
    '📡 Тривога в ефірі, ховайся як можеш!',
    '🤖 Говно в небі, тримай оборону!',
    '💣 Обійми бетон — прилетить щось гаряче!',
    '🧻 Бери труси на запас — буде голосно!',
    '🫠 Не бойся, ти просто NPC в цій грі!',
    '🌪️ Хмари дивні, чи то вже летить?',
    '🧨 Щось дзвенить, може то не в вухах?',
    '📢 Оголошення: летить лайно. Ховайся!',
    '📦 Доставка: Shahed Prime, без підпису!',
    '🏃‍♂️ Біжи, Лоло, біжи!',
    '😵‍💫 Ракета пролетіла? Чи то голуб?',
    '📉 Рівень спокою: мінус п‘ятсот',
    '😬 Не сци, сци обережно!',
    '🕳️ Твій унітаз — найкращий бункер',
    '🥶 Гуси мовчать — значить вже близько',
    '🛑 Мозок каже "ти вдома", а шахед каже "перевіримо"',
    '😈 У кого є житло в Польщі — час згадати!',
    '📦 Прилетів подарунок з московської любов’ю!',
    '🔊 Саундтрек до життя: "виииииииииууууу!"',
    '🫡 Включи дурника — може не помітять',
    '🕵️‍♂️ Сиджу в туалеті як Джеймс Бонд',
    '🧽 Протріть вікна. Останній раз, може',
    '👃 Чуєш? Це тривога чи борщ?',
    '👋 Скажи мамі, що любиш її. Ну так, на всяк',
    '🚽 Якщо смердить — це не паніка, це ти',
    '💤 Заснув? Ну то тепер точно прокинешся',
    '🧠 Думай швидко! А, вже пізно',
    '🥸 Якшо мовчиш — може подумає що тебе нема',
    '🏚️ З’їж з підвіконня, ти не голуб!',
    '🦆 Шахед або качка — рулетка життя!',
    '🌈 У кого бронік з блискітками — ті непомітні',
    '🔕 Вимкни звук. Ракета ж не глуха!',
    '🥴 "Не прилетить по мені" — відомі останні слова',
    '🫣 Руки вгору! Ааа, ні, це не ОМОН...',
    '🎉 Свято наближається — у вигляді обстрілу!',
    '📦 Летить посилка без трек-коду',
    '🧃 Якщо зранку — то це кавоудар',
    '📛 Вийшов надвір? Тепер живеш у бойовику',
    '🪦 Якщо тиша — це не добре, це дуже погано',
    '🐖 Приліт по хліву — то вже свинство',
    '🧼 Помився? Дарма — буде знову пилюка',
    '💅 Шахедик підлетів на манікюр',
    '🧠 Запам’ятай: спочатку "вииии", потім "бум!"',
    '🥹 Не сци, ти не один. Ми всі тут сремо разом',
    
]

jokes_volyn = [
    '🐽 Волинь, притискайся до кабана!',
    '🧅 Ковель, тримай голову в буряках!',
    '🛢️ Приліт над Волинню — а ми тільки сало закопали!',
    '🪖 Волинь, сховайсь! Вже летить!',
    '📍Карта Волині активована. Готуйся!',
    '📍 Вітаємо у Волинській зоні турбулентності',
]

recent_ids = set()

@client.on(events.NewMessage)
async def handler(event):
    try:
        if event.id in recent_ids:
            return
        recent_ids.add(event.id)

        text = event.message.message or ''
        text_lower = text.lower()

        # ❌ Фільтр спаму
        if any(bad in text_lower for bad in banwords):
            return

        # ✅ Фільтр шахедів
        if not any(word in text_lower for word in keywords):
            return

        # 📸 Якщо є фото — надсилаємо окремо
        if event.photo:
            file = await event.download_media()
            await bot.send_photo(chat_id=chat_id, photo=open(file, 'rb'))
            os.remove(file)

        # 🧠 Вибір жарту
        joke = random.choice(jokes_volyn if any(city in text_lower for city in ['волин', 'луцьк', 'ковель']) else jokes_default)

        # 📤 Відправка в групу
        await bot.send_message(chat_id=chat_id, text=f"<b>{joke}</b>\n\n{text}", parse_mode='HTML')

    except Exception as e:
        logging.error(f'❌ Error: {e}')

async def main():
    await client.start()
    print('✅ Shahedyk запущено.')
    await client.run_until_disconnected()

if __name__ == '__main__':
    logging.basicConfig(level=logging.INFO)
    asyncio.run(main())
